<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Video - Video Translation App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .processing-container {
            max-width: 600px;
            margin: 0 auto;
        }
        .progress-step {
            text-align: center;
            margin: 20px 0;
        }
        .step-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .current-step {
            color: #007bff;
        }
        .completed-step {
            color: #28a745;
        }
        .pending-step {
            color: #6c757d;
        }
        .processing-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .error-container {
            display: none;
        }
        .success-container {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="processing-container">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="mb-0"><i class="bi bi-gear-fill processing-animation"></i> Processing Your Video</h3>
                </div>
                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="progress" style="height: 20px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%">0%</div>
                        </div>
                        <div class="text-center mt-2">
                            <small id="statusMessage" class="text-muted">Initializing...</small>
                        </div>
                    </div>

                    <!-- Processing Steps -->
                    <div class="row text-center">
                        <div class="col processing-step" id="step1">
                            <div class="step-icon pending-step">
                                <i class="bi bi-upload"></i>
                            </div>
                            <small>Upload</small>
                        </div>
                        <div class="col processing-step" id="step2">
                            <div class="step-icon pending-step">
                                <i class="bi bi-music-note"></i>
                            </div>
                            <small>Extract Audio</small>
                        </div>
                        <div class="col processing-step" id="step3">
                            <div class="step-icon pending-step">
                                <i class="bi bi-mic"></i>
                            </div>
                            <small>Transcribe</small>
                        </div>
                        <div class="col processing-step" id="step4">
                            <div class="step-icon pending-step">
                                <i class="bi bi-translate"></i>
                            </div>
                            <small>Translate</small>
                        </div>
                        <div class="col processing-step" id="step5">
                            <div class="step-icon pending-step">
                                <i class="bi bi-badge-cc"></i>
                            </div>
                            <small>Add Subtitles</small>
                        </div>
                    </div>

                    <!-- Loading Message -->
                    <div id="loadingContainer" class="text-center mt-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Please wait while we process your video. This may take several minutes depending on the video length.</p>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Tip:</strong> You can safely close this tab. We'll save your processed video for download.
                        </div>
                    </div>

                    <!-- Error Container -->
                    <div id="errorContainer" class="error-container">
                        <div class="alert alert-danger">
                            <h5><i class="bi bi-exclamation-triangle"></i> Processing Error</h5>
                            <p id="errorMessage">An error occurred while processing your video.</p>
                            <a href="/" class="btn btn-primary">Try Again</a>
                        </div>
                    </div>

                    <!-- Success Container -->
                    <div id="successContainer" class="success-container">
                        <div class="alert alert-success text-center">
                            <h5><i class="bi bi-check-circle"></i> Processing Complete!</h5>
                            <p>Your video has been successfully translated with English subtitles.</p>
                            <div class="alert alert-info mb-3">
                                <strong><i class="bi bi-info-circle"></i> What you'll get:</strong><br>
                                • Original video file<br>
                                • English subtitle file (.srt)<br>
                                • Instructions on how to use subtitles<br>
                                <small class="text-muted">Use VLC Player to automatically load subtitles!</small>
                            </div>
                            <a id="downloadBtn" href="#" class="btn btn-success btn-lg">
                                <i class="bi bi-download"></i> Download Video + Subtitles
                            </a>
                            <br><br>
                            <a href="/" class="btn btn-outline-primary">Process Another Video</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const taskId = '{{ task_id }}';
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');
        const loadingContainer = document.getElementById('loadingContainer');
        const errorContainer = document.getElementById('errorContainer');
        const successContainer = document.getElementById('successContainer');
        const errorMessage = document.getElementById('errorMessage');
        const downloadBtn = document.getElementById('downloadBtn');

        let currentStep = 0;
        const steps = ['step1', 'step2', 'step3', 'step4', 'step5'];

        function updateStepStatus(stepIndex, status) {
            const step = document.getElementById(steps[stepIndex]);
            const icon = step.querySelector('.step-icon');

            icon.className = 'step-icon ' + status + '-step';

            if (status === 'current') {
                icon.classList.add('processing-animation');
            } else {
                icon.classList.remove('processing-animation');
            }
        }

        function updateProgress(progress, message, status) {
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
            statusMessage.textContent = message;

            // Update step indicators
            if (progress >= 0 && currentStep < 1) {
                updateStepStatus(0, 'completed');
                currentStep = 1;
            }
            if (progress >= 30 && currentStep < 2) {
                updateStepStatus(0, 'completed');
                updateStepStatus(1, 'current');
                currentStep = 2;
            }
            if (progress >= 60 && currentStep < 3) {
                updateStepStatus(1, 'completed');
                updateStepStatus(2, 'current');
                currentStep = 3;
            }
            if (progress >= 80 && currentStep < 4) {
                updateStepStatus(2, 'completed');
                updateStepStatus(3, 'current');
                currentStep = 4;
            }
            if (progress >= 90 && currentStep < 5) {
                updateStepStatus(3, 'completed');
                updateStepStatus(4, 'current');
                currentStep = 5;
            }

            if (status === 'completed') {
                updateStepStatus(4, 'completed');
                progressBar.classList.remove('progress-bar-animated');
                loadingContainer.style.display = 'none';
                successContainer.style.display = 'block';
                downloadBtn.href = '/download/' + taskId;
            } else if (status === 'error') {
                progressBar.classList.add('bg-danger');
                loadingContainer.style.display = 'none';
                errorContainer.style.display = 'block';
                errorMessage.textContent = message;
            }
        }

        function checkStatus() {
            fetch('/status/' + taskId)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'not_found') {
                        errorMessage.textContent = 'Processing task not found.';
                        loadingContainer.style.display = 'none';
                        errorContainer.style.display = 'block';
                        return;
                    }

                    updateProgress(data.progress || 0, data.message || 'Processing...', data.status);

                    if (data.status === 'processing' || data.status === 'uploaded') {
                        setTimeout(checkStatus, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    setTimeout(checkStatus, 5000);
                });
        }

        // Start checking status
        updateStepStatus(0, 'current');
        checkStatus();
    </script>
</body>
</html>